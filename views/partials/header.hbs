<header>
  <nav class='bg-white shadow-sm sticky top-0 z-50'>
    <div class='max-w-7xl mx-auto px-4 sm:px-6 lg:px-8'>
      <div class='flex justify-between items-center h-16'>

        <div class='flex items-center space-x-2 order-2 sm:order-none'>
          <i class='fas fa-ticket-alt text-2xl text-indigo-600'></i>
          <a
            href='https://military-rory-epitech-c96fb691.koyeb.app/'
            class='text-2xl font-bold tracking-wider'
          >TICKETER</a>
        </div>

        <div class='hidden md:flex items-center space-x-8 order-1'>
          <a
            href='/'
            class='text-gray-700 hover:text-gray-900 font-medium'
          >Accueil</a>
          <a
            href='/concerts/view'
            class='text-gray-700 hover:text-gray-900 font-medium'
          >Concerts</a>
          <a
            href='/groups/singles'
            class='text-gray-700 hover:text-gray-900 font-medium'
          >Groupes Musicaux</a>
        </div>

        <div class='flex items-center space-x-4 order-3'>

          <button
            id='mobileMenuBtn'
            class='md:hidden text-gray-700 hover:text-gray-900 focus:outline-none p-2'
          >
            <i class='fas fa-bars text-xl'></i>
          </button>

          <a
            id='loginBtn'
            href='/login'
            class='bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 sm:px-6 sm:py-2 rounded-full font-medium flex items-center space-x-2 transition text-sm whitespace-nowrap'
          >
            <i class='fas fa-user'></i>
            <span class='hidden sm:inline'>Login/Register</span>
          </a>

          <div id='userConnected' class='hidden flex items-center space-x-4'>
            <div class='flex items-center space-x-2'>
              <div
                id='userAvatar'
                class='w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm'
              ></div>
              <div class='hidden sm:block'>
                <p id='userName' class='text-sm font-medium text-gray-700'></p>
                <p id='userEmail' class='text-xs text-gray-500'></p>
              </div>
            </div>

            <div class='relative'>
              <button
                id='menuBtn'
                class='text-gray-700 hover:text-gray-900 focus:outline-none'
              >
                <i class='fas fa-chevron-down text-sm'></i>
              </button>

              <div
                id='profileMenu'
                class='hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-10'
              >
                <a
                  href='/profile'
                  class='block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition'
                >
                  <i class='fas fa-user-circle mr-2'></i>
                  Mon Compte
                </a>
                <a
                  href='/profile#settings'
                  class='block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition'
                >
                  <i class='fas fa-cog mr-2'></i>
                  Paramètres
                </a>
                <a
                  href='/bookings/history'
                  class='block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition'
                >
                  <i class='fas fa-receipt mr-2'></i>
                  Mes Tickets
                </a>
                <div id='adminLink' class='hidden border-t'>
                  <a
                    href='/admin'
                    class='block px-4 py-2 text-sm text-blue-600 hover:bg-blue-50'
                  >
                    <i class='fas fa-crown mr-2'></i>
                    Admin Panel
                  </a>
                </div>
                <button
                  id='logoutBtn'
                  class='w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 border-t transition'
                >
                  <i class='fas fa-sign-out-alt mr-2'></i>
                  Déconnexion
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div id='mobileMenu' class='md:hidden hidden bg-gray-50 border-b shadow-sm'>
    <div class='px-2 pt-2 pb-3 space-y-1 sm:px-3'>
      <a
        href='/'
        class='block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-200'
      >Accueil</a>
      <a
        href='/concerts/view'
        class='block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-200'
      >Concerts</a>
      <a
        href='/groups/singles'
        class='block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-200'
      >Groupes Musicaux</a>
    </div>
  </div>
</header>

<script>
class UserSessionManager {
  constructor() {
    this.user = null;
  }

  async init() {
    try {
      const response = await fetch('/auth/check', {
        credentials: 'include'
      });

      if (!response.ok) throw new Error('Non authentifié');

      const data = await response.json();
      if (!data.success || !data.user) throw new Error('Non authentifié');

      this.user = data.user;
      this.renderConnected();
    } catch {
      this.renderNotConnected();
    }
    
    // Initialisation des écouteurs pour le menu mobile après le rendu
    this.setupMobileMenuListener();
  }

  renderNotConnected() {
    document.getElementById('loginBtn').classList.remove('hidden');
    document.getElementById('userConnected').classList.add('hidden');
  }

  renderConnected() {
    document.getElementById('loginBtn').classList.add('hidden');
    document.getElementById('userConnected').classList.remove('hidden');

    document.getElementById('userAvatar').textContent = this.getInitials();
    document.getElementById('userName').textContent = this.escapeHtml(this.user.username);
    document.getElementById('userEmail').textContent = this.escapeHtml(this.user.email);

    if (this.user.isAdmin) {
      document.getElementById('adminLink').classList.remove('hidden');
    }

    this.setupProfileMenuListeners();
  }

  // Ancien setupMenuListeners renommé pour plus de clarté
  setupProfileMenuListeners() {
    const menuBtn = document.getElementById('menuBtn');
    const profileMenu = document.getElementById('profileMenu');
    const logoutBtn = document.getElementById('logoutBtn');

    if (!menuBtn || !profileMenu || !logoutBtn) return;

    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      profileMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!menuBtn.contains(e.target) && !profileMenu.contains(e.target)) {
        profileMenu.classList.add('hidden');
      }
    });

    logoutBtn.addEventListener('click', () => this.logout());
  }
  
  // NOUVELLE MÉTHODE POUR LE MENU MOBILE
  setupMobileMenuListener() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');

    if (!mobileMenuBtn || !mobileMenu) return;

    mobileMenuBtn.addEventListener('click', () => {
      // Toggle l'affichage du menu mobile
      mobileMenu.classList.toggle('hidden');
    });
  }

  async logout() {
    try {
      const response = await fetch('/logout', {
        method: 'POST',
        credentials: 'include',
      });

      if (!response.ok) throw new Error();

      this.user = null;
      this.renderNotConnected();
      window.location.href = '/login';
    } catch {
      alert('Erreur lors de la déconnexion.');
    }
  }

  getInitials() {
    if (!this.user?.username) return 'U';
    // Assure d'utiliser les 2 premiers caractères des 2 premiers mots si le nom est long
    return this.user.username.split(' ').map(p => p[0]).join('').toUpperCase().substring(0, 2);
  }

  escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const userSessionManager = new UserSessionManager();
  userSessionManager.init();
});
</script>